{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Property Listings</h2>

  <div class="row">
    
    <!-- Sidebar Filter -->
    <div class="col-md-3">
      <div class="card p-3 shadow-sm sticky-top" style="top: 90px;">
        <h5 class="mb-3">Filter Properties</h5>

        <form method="GET">

          <div class="mb-3">
            <label class="form-label">Search</label>
            <input type="text" name="q" class="form-control" placeholder="Location or Name" value="{{ request.GET.q }}">
          </div>

          <div class="mb-3">
            <label class="form-label">BHK</label>
            <select name="bhk" class="form-select">
              <option value="">Any</option>
              <option value="1" {% if request.GET.bhk == '1' %}selected{% endif %}>1 BHK</option>
              <option value="2" {% if request.GET.bhk == '2' %}selected{% endif %}>2 BHK</option>
              <option value="3" {% if request.GET.bhk == '3' %}selected{% endif %}>3 BHK</option>
              <option value="4" {% if request.GET.bhk == '4' %}selected{% endif %}>4+ BHK</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Min Price (Lakh)</label>
            <input type="number" name="min_price" class="form-control" value="{{ request.GET.min_price }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Max Price (Lakh)</label>
            <input type="number" name="max_price" class="form-control" value="{{ request.GET.max_price }}">
          </div>

          <button class="btn btn-primary w-100">Apply Filters</button>

        </form>
      </div>
    </div>

    <!-- Property Listings -->
    <div class="col-md-9">
      <div class="row">
        {% for property in properties %}
        <div class="col-md-4 d-flex justify-content-center">
          <div class="property-card mb-4 border rounded bg-white" style="width: 300px;">
            {% if property.image %}
            <img src="{{ property.image.url }}" class="card-img-top" alt="{{ property.name }}">
            {% else %}
            <img src="{% static 'images/default_property.jpg' %}" class="card-img-top" alt="No image">
            {% endif %}

            <div class="p-3">
              <h5>{{ property.name }}</h5>
           <p>{{ property.description|truncatechars:150 }}</p>

              <p><strong>Location:</strong> {{ property.location }}</p>
              <p><strong>BHK:</strong> {{ property.bhk }}</p>
              <p><strong>Price:</strong> {{ property.price }} Lakh</p>

              {% if request.session.form_filled %}
                {% if property.brochure %}
                <a href="{{ property.brochure.url }}" class="btn btn-success mt-2" download>
                  Download Brochure
                </a>
                {% endif %}
              {% else %}
              <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#contactModal"
                data-property-id="{{ property.id }}">
                Request Brochure
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">No properties found.</p>
        {% endfor %}
      </div>
    </div>

  </div>
</div>

<!-- Script to store property_id -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const contactModal = document.getElementById('contactModal');
    const propertyIdInput = document.getElementById('propertyIdInput');

    contactModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const propertyId = button.getAttribute('data-property-id');
      propertyIdInput.value = propertyId;
    });
  });
</script>

<!-- Styles -->
<style>
  .property-card img.card-img-top {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
  }

  .property-card {
    transition: box-shadow 0.3s ease;
  }

  .property-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .filter-section {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }
</style>
{% endblock content %}