{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

  <!-- ðŸ”¹ Loading Spinner Overlay -->
  <div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <h2 class="mb-4 text-center">Property Listings</h2>

  <div class="row p-4">
    
    <!-- Sidebar Filter -->
    <div class="col-md-3">
      <div class="card p-3 shadow-sm sticky-top" style="top: 90px;">
        <h5 class="mb-3">Filter Properties</h5>

        <form method="GET" id="filter-form">
          <div class="mb-3">
            <label class="form-label">Search</label>
            <input type="text" name="q" class="form-control" placeholder="Location or Name" value="{{ request.GET.q }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Enter Sqft</label>
            <input type="text" name="sq_ft" class="form-control" placeholder="Enter your Sqft" value="{{ request.GET.sq_ft }}">
          </div>

          <div class="mb-3">
            <label class="form-label">BHK</label>
            <select name="bhk" class="form-select">
              <option value="">Any</option>
              <option value="1" {% if request.GET.bhk == '1' %}selected{% endif %}>1 BHK</option>
              <option value="2" {% if request.GET.bhk == '2' %}selected{% endif %}>2 BHK</option>
              <option value="3" {% if request.GET.bhk == '3' %}selected{% endif %}>3 BHK</option>
              <option value="4" {% if request.GET.bhk == '4' %}selected{% endif %}>4+ BHK</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Min Price (Lakh)</label>
            <input type="number" name="min_price" class="form-control" value="{{ request.GET.min_price }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Max Price (Lakh)</label>
            <input type="number" name="max_price" class="form-control" value="{{ request.GET.max_price }}">
          </div>

          <button class="btn btn-primary w-100" type="submit" style="background-color: #d4af37;">Apply Filters</button>
          <a href="{% url 'properties' %}" class="btn btn-secondary w-100 mt-2" style="background-color: #d4af37;">Clear Filters</a>
        </form>
      </div>
    </div>

    <!-- Property Listings -->
    <div class="col-md-9">
      <div class="row fade-in" id="property-list">
        {% for property in page_obj %}
        <div class="col-md-4 d-flex justify-content-center">
          <div class="property-card mb-4 border rounded bg-white" style="width: 300px; position: relative;">
            
            {% if property.image %}
              <img src="{{ property.image.url }}" class="card-img-top" alt="{{ property.name }}">
            {% else %}
              <img src="{% static 'images/default_property.jpg' %}" class="card-img-top" alt="No image">
            {% endif %}

            <div class="p-3">
              <h5>{{ property.name }}</h5>

              <!-- Hover Dialog Trigger -->
              <div class="property-description">
                <p class="text-muted small">Hover to view full description</p>
                <div class="hover-dialog">
                  <p>{{ property.description }}</p>
                </div>
              </div>

              <p><strong>Location:</strong> {{ property.location }}</p>
              <p><strong>BHK:</strong> {{ property.bhk_type }}</p>
              <p><strong>Sq Ft:</strong> {{ property.sq_ft }} Sq Ft</p>
              {% comment %} <p><strong>Price:</strong> {{ property.price }} Lakh</p> {% endcomment %}

              {% if request.session.name and request.session.email and request.session.phone %}
                {% if property.floor_plane_image %}
                  <a href="{{ property.floor_plane_image.url }}" download class="btn btn-outline-primary btn-sm mt-2 w-100">
                    Download Floor Plan
                  </a>
                {% endif %}

                {% if property.brochure %}
                  <a href="{% url 'download_brochure' %}?id={{ property.id }}" class="btn mt-2" style="background-color: #d4af37; color: #fff;">
                    Download Brochure
                  </a>
                {% endif %}
              {% else %}
                <button class="btn mt-2 request-brochure-btn" style="background-color: #d4af37; color: #fff;"
                    data-property-id="{{ property.id }}">
              Request Brochure
            </button>

              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">No properties found.</p>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- ðŸ”¹ JS Script for Loader -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const overlay = document.getElementById('loading-overlay');
    const form = document.getElementById('filter-form');
    const propertyList = document.getElementById('property-list');

    if (form) {
      form.addEventListener('submit', function () {
        overlay.style.display = 'flex';
      });
    }

    document.querySelectorAll('.pagination a').forEach(link => {
      link.addEventListener('click', function () {
        overlay.style.display = 'flex';
      });
    });

    window.addEventListener('load', function () {
      setTimeout(() => {
        overlay.style.display = 'none';
        if (propertyList) propertyList.classList.add('fade-in');
      }, 400);
    });

    // âœ… Fix: Add click for all "Request Brochure" buttons
    document.querySelectorAll('.request-brochure-btn').forEach(button => {
      button.addEventListener('click', function() {
        window.location.href = "{% url 'login' %}";
      });
    });
  });
</script>


<!-- ðŸ”¹ Styles -->
<style>
  .property-card img.card-img-top {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .property-card {
    transition: box-shadow 0.3s ease;
    cursor: pointer;
  }

  .property-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }

  /* Hover dialog styles */
  .hover-dialog {
    display: none;
    position: absolute;
    top: 10px;
    left: 105%;
    width: 250px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10;
  }

  .property-card:hover .hover-dialog {
    display: block;
  }

  #loading-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(255,255,255,0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .fade-in {
    animation: fadeIn 0.6s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock content %}
