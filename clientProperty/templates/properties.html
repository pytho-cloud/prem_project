{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">

  <!-- ðŸ”¹ Loading Spinner Overlay -->
  <div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <h2 class="mb-4 text-center">Property Listings</h2>

  <div class="row">
    
    <!-- Sidebar Filter -->
    <div class="col-md-3">
      <div class="card p-3 shadow-sm sticky-top" style="top: 90px;">
        <h5 class="mb-3">Filter Properties</h5>

        <form method="GET" id="filter-form">

          <div class="mb-3">
            <label class="form-label">Search</label>
            <input type="text" name="q" class="form-control" placeholder="Location or Name" value="{{ request.GET.q }}">
          </div>

          <div class="mb-3">
            <label class="form-label">BHK</label>
            <select name="bhk" class="form-select">
              <option value="">Any</option>
              <option value="1" {% if request.GET.bhk == '1' %}selected{% endif %}>1 BHK</option>
              <option value="2" {% if request.GET.bhk == '2' %}selected{% endif %}>2 BHK</option>
              <option value="3" {% if request.GET.bhk == '3' %}selected{% endif %}>3 BHK</option>
              <option value="4" {% if request.GET.bhk == '4' %}selected{% endif %}>4+ BHK</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Min Price (Lakh)</label>
            <input type="number" name="min_price" class="form-control" value="{{ request.GET.min_price }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Max Price (Lakh)</label>
            <input type="number" name="max_price" class="form-control" value="{{ request.GET.max_price }}">
          </div>

          <button class="btn btn-primary w-100" type="submit">Apply Filters</button>
          <a href="{% url 'properties' %}" class="btn btn-secondary w-100 mt-2">Clear Filters</a>
        </form>
      </div>
    </div>

    <!-- Property Listings -->
    <div class="col-md-9">
      <div class="row fade-in" id="property-list">
        {% for property in page_obj %}
        <div class="col-md-4 d-flex justify-content-center">
          <div class="property-card mb-4 border rounded bg-white" style="width: 300px;">
            
            {% if property.image %}
              <img src="{{ property.image.url }}" class="card-img-top" alt="{{ property.name }}">
            {% else %}
              <img src="{% static 'images/default_property.jpg' %}" class="card-img-top" alt="No image">
            {% endif %}

            <div class="p-3">
              <h5>{{ property.name }}</h5>
              <p>{{ property.description|truncatechars:150 }}</p>
              <p><strong>Location:</strong> {{ property.location }}</p>
              <p><strong>BHK:</strong> {{ property.bhk_type }}</p>
              <p><strong>Price:</strong> {{ property.price }} Lakh</p>

              {% if request.session.form_filled %}
                {% if property.brochure %}
                  <a href="{{ property.brochure.url }}" class="btn btn-success mt-2" download>
                    Download Brochure
                  </a>
                {% endif %}
              {% else %}
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#contactModal"
                        data-property-id="{{ property.id }}">
                  Request Brochure
                </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">No properties found.</p>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">

          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.bhk %}&bhk={{ request.GET.bhk }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">
                Previous
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.bhk %}&bhk={{ request.GET.bhk }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.bhk %}&bhk={{ request.GET.bhk }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">
                Next
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- ðŸ”¹ JS Script for Loader and Modal -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const contactModal = document.getElementById('contactModal');
    const propertyIdInput = document.getElementById('propertyIdInput');
    const form = document.getElementById('filter-form');
    const overlay = document.getElementById('loading-overlay');
    const propertyList = document.getElementById('property-list');

    // Handle modal property ID
    if (contactModal && propertyIdInput) {
      contactModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const propertyId = button.getAttribute('data-property-id');
        propertyIdInput.value = propertyId;
      });
    }

    // Show loader when submitting filters
    if (form) {
      form.addEventListener('submit', function () {
        overlay.style.display = 'flex';
      });
    }

    // Show loader on pagination click
    document.querySelectorAll('.pagination a').forEach(link => {
      link.addEventListener('click', function () {
        overlay.style.display = 'flex';
      });
    });

    // Hide loader after page fully loads
    window.addEventListener('load', function () {
      setTimeout(() => {
        overlay.style.display = 'none';
        if (propertyList) propertyList.classList.add('fade-in');
      }, 400); // 0.4s delay for smooth transition
    });
  });
</script>

<!-- ðŸ”¹ Styles -->
<style>
  /* Property Card */
  .property-card img.card-img-top {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
  }

  .property-card {
    transition: box-shadow 0.3s ease;
  }

  .property-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Loading Overlay */
  #loading-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(255,255,255,0.7);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Fade-in Animation */
  .fade-in {
    animation: fadeIn 0.6s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

{% endblock content %}